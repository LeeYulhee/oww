### ê²½ìš°ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ ì¼ë°˜ì ìœ¼ë¡œ ìˆëŠ” ê²Œ ì¢‹ìŒ

íŠ¸ëœì­ì…˜ì´ ì—†ëŠ” ì¡°íšŒ:
```java
javapublic User findUser() {
    return userRepository.findById(1L); // íŠ¸ëœì­ì…˜ ì—†ìŒ
}
```
- DB ì»¤ë„¥ì…˜ì„ ë§¤ë²ˆ ìƒˆë¡œ ê°€ì ¸ì˜´
- ì¿¼ë¦¬ ì‹¤í–‰ í›„ ì¦‰ì‹œ ì»¤ë„¥ì…˜ ë°˜í™˜

<br>

íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ì¡°íšŒ:
```java
@Transactional(readOnly = true)
public User findUser() {
    return userRepository.findById(1L); // íŠ¸ëœì­ì…˜ ìˆìŒ
}
```
**íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë©´ ì¢‹ì€ ì´ìœ :**
- Lazy Loading ë³´ì¥: JPAì—ì„œ ì—°ê´€ê´€ê³„ ë°ì´í„°ë¥¼ ë‚˜ì¤‘ì— ê°€ì ¸ì˜¬ ë•Œ íŠ¸ëœì­ì…˜ í•„ìš”
- ì¼ê´€ëœ ì½ê¸°: ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ë°ì´í„° ì¼ê´€ì„± ë³´ì¥
- DB ìµœì í™”: readOnly=trueë¡œ DBì—ê²Œ íŒíŠ¸ ì œê³µ


**íŠ¸ëœì­ì…˜ì´ ê¼­ í•„ìš”í•œ ê²½ìš°:**
- Lazy Loading ì‚¬ìš©: ì—°ê´€ê´€ê³„ ë°ì´í„°ë¥¼ ë‚˜ì¤‘ì— ê°€ì ¸ì˜¬ ë•Œ
- ì—¬ëŸ¬ ì¿¼ë¦¬ ì‹¤í–‰: í•œ ë©”ì„œë“œì—ì„œ ì—¬ëŸ¬ Repository í˜¸ì¶œí•  ë•Œ
- ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§: ë°ì´í„° ì¼ê´€ì„±ì´ ì¤‘ìš”í•  ë•Œ

**íŠ¸ëœì­ì…˜ì´ ì—†ì–´ë„ ë˜ëŠ” ê²½ìš°:**
- ë‹¨ìˆœ ì¡°íšŒ: í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ëë‚˜ëŠ” ê²½ìš°
- Eager Loading: ëª¨ë“  ë°ì´í„°ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜¤ëŠ” ê²½ìš°
- ê¸°ë³¸ íƒ€ì… ë°˜í™˜: boolean, int ë“± ë‹¨ìˆœ ê°’ë§Œ ë¦¬í„´

**í˜„ì‹¤ì ì¸ ì ‘ê·¼:**

- í´ë˜ìŠ¤ ë ˆë²¨ì— @Transactional(readOnly = true): ì•ˆì „í•˜ê³  í¸í•¨
- ì„±ëŠ¥ ì°¨ì´ëŠ” ë¯¸ë¯¸í•¨: ë‹¨ìˆœ ì¡°íšŒì—ì„œëŠ” íŠ¸ëœì­ì…˜ ì˜¤ë²„í—¤ë“œê°€ í¬ì§€ ì•ŠìŒ
- Lazy Loading ì‹¤ìˆ˜ ë°©ì§€: ë‚˜ì¤‘ì— ì½”ë“œ ìˆ˜ì •í•  ë•Œ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°©ì§€

```java
@Entity
public class User {
    @OneToMany(fetch = FetchType.LAZY) // ê¸°ë³¸ê°’
    private List<WorkoutRecord> workoutRecords;
}

// ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ
public class UserService {
    
    // íŠ¸ëœì­ì…˜ ì—†ìŒ
    public User findUserWithWorkouts(UUID userId) {
        User user = userRepository.findById(userId).get();
        
        // ì—¬ê¸°ì„œ LazyInitializationException ë°œìƒ!
        // ì´ë¯¸ DB ì»¤ë„¥ì…˜ì´ ë‹«í˜”ëŠ”ë° workoutRecordsë¥¼ ê°€ì ¸ì˜¤ë ¤ê³  ì‹œë„
        int workoutCount = user.getWorkoutRecords().size();
        
        return user;
    }
}

// í•´ê²°ëœ ì½”ë“œ
public class UserService {
    
    @Transactional(readOnly = true) // íŠ¸ëœì­ì…˜ ìˆìŒ
    public User findUserWithWorkouts(UUID userId) {
        User user = userRepository.findById(userId).get();
        
        // íŠ¸ëœì­ì…˜ì´ ìˆì–´ì„œ DB ì»¤ë„¥ì…˜ì´ ì‚´ì•„ìˆìŒ
        // Lazy Loading ì„±ê³µ!
        int workoutCount = user.getWorkoutRecords().size();
        
        return user;
    }
}

// 2. ì»¤ë„¥ì…˜ í’€ íš¨ìœ¨ì„±

// íŠ¸ëœì­ì…˜ ì—†ëŠ” ê²½ìš°
public User findUser() {
    // ë§¤ë²ˆ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ ìš”ì²­
    return userRepository.findById(1L); // ì»¤ë„¥ì…˜ 1ë²ˆ
}

public List<WorkoutRecord> findWorkouts() {
    // ë˜ ë‹¤ë¥¸ ì»¤ë„¥ì…˜ ìš”ì²­  
    return workoutRepository.findByUserId(1L); // ì»¤ë„¥ì…˜ 2ë²ˆ
}

// ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ
public void someController() {
    User user = userService.findUser();           // ì»¤ë„¥ì…˜ 1 ì‚¬ìš© í›„ ë°˜í™˜
    List<WorkoutRecord> workouts = workoutService.findWorkouts(); // ì»¤ë„¥ì…˜ 2 ì‚¬ìš© í›„ ë°˜í™˜
}

// íŠ¸ëœì­ì…˜ ìˆëŠ” ê²½ìš°
@Transactional(readOnly = true)
public UserWithWorkouts findUserWithWorkouts() {
    User user = userRepository.findById(1L);              // ì»¤ë„¥ì…˜ 1 ì‚¬ìš©
    List<WorkoutRecord> workouts = workoutRepository.findByUserId(1L); // ê°™ì€ ì»¤ë„¥ì…˜ 1 ì¬ì‚¬ìš©
    return new UserWithWorkouts(user, workouts);
}

// 3. ì‹¤ì œë¡œëŠ” ì–¸ì œ íŠ¸ëœì­ì…˜ì´ í•„ìš”í•˜ê³  ë¶ˆí•„ìš”í•œê°€?

// íŠ¸ëœì­ì…˜ì´ ê¼­ í•„ìš”í•œ ê²½ìš°ë“¤:
public class UserService {
    
    // âŒ íŠ¸ëœì­ì…˜ ì—†ìœ¼ë©´ LazyInitializationException
    public UserDto getUserWithDetails(UUID userId) {
        User user = userRepository.findById(userId).get();
        
        // Lazy Loading ë°œìƒ
        List<String> groupNames = user.getGroupMembers().stream()
            .map(member -> member.getGroup().getGroupName())
            .toList();
            
        return UserDto.builder()
            .user(user)
            .groupNames(groupNames)
            .build();
    }
    
    // âŒ íŠ¸ëœì­ì…˜ ì—†ìœ¼ë©´ ì—¬ëŸ¬ ì¿¼ë¦¬ê°€ ê°ê° ë‹¤ë¥¸ ì»¤ë„¥ì…˜ ì‚¬ìš©
    public UserStats getUserStats(UUID userId) {
        User user = userRepository.findById(userId).get();      // ì¿¼ë¦¬ 1
        int workoutCount = workoutRepository.countByUserId(userId); // ì¿¼ë¦¬ 2  
        int groupCount = groupRepository.countByUserId(userId);     // ì¿¼ë¦¬ 3
        
        return new UserStats(user, workoutCount, groupCount);
    }
}

// íŠ¸ëœì­ì…˜ì´ ì—†ì–´ë„ ë˜ëŠ” ê²½ìš°ë“¤:
public class UserService {
    
    // âœ… ë‹¨ìˆœ ì¡°íšŒ, Lazy Loading ì—†ìŒ
    public User findByEmail(String email) {
        return userRepository.findByEmail(email)
            .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));
    }
    
    // âœ… ë‹¨ìˆœ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    public boolean existsByEmail(String email) {
        return userRepository.existsByEmail(email);
    }
}

// 4. í˜„ì‹¤ì ì¸ ì ‘ê·¼ë²•

@Service
@Transactional(readOnly = true) // ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
public class UserService {
    
    // ë³µì¡í•œ ì¡°íšŒ - íŠ¸ëœì­ì…˜ í˜œíƒì„ ë°›ìŒ
    public UserDetailDto getUserDetail(UUID userId) {
        User user = userRepository.findById(userId).get();
        // Lazy Loading ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
        return UserDetailDto.from(user);
    }
    
    // ë‹¨ìˆœ ì¡°íšŒ - íŠ¸ëœì­ì…˜ì´ ìˆì–´ë„ ì„±ëŠ¥ì— í° ì˜í–¥ ì—†ìŒ  
    public User findByEmail(String email) {
        return userRepository.findByEmail(email)
            .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));
    }
    
    @Transactional // ì“°ê¸° ì‘ì—…
    public void createUser(User user) {
        userRepository.save(user);
    }
}

// 5. ì„±ëŠ¥ ë¹„êµ ì˜ˆì‹œ (ì˜ì‚¬ì½”ë“œ)

// íŠ¸ëœì­ì…˜ ì—†ìŒ - ë§¤ë²ˆ ì»¤ë„¥ì…˜ íšë“/ë°˜í™˜
Method: findUser()
â”œâ”€ Connection.acquire()     // 10ms
â”œâ”€ SELECT * FROM users      // 5ms  
â””â”€ Connection.release()     // 5ms
Total: 20ms

// íŠ¸ëœì­ì…˜ ìˆìŒ - ì»¤ë„¥ì…˜ ì¬ì‚¬ìš©
Method: findUserWithDetails()  
â”œâ”€ Transaction.begin() + Connection.acquire()  // 10ms
â”œâ”€ SELECT * FROM users                         // 5ms
â”œâ”€ SELECT * FROM workout_records (lazy)        // 5ms
â”œâ”€ SELECT * FROM groups (lazy)                 // 5ms
â””â”€ Transaction.commit() + Connection.release() // 5ms
Total: 30ms (vs 60ms if separate transactions)
```

### ê²°ë¡ : ê¶Œì¥ íŒ¨í„´
**âœ… Serviceì—ë§Œ í´ë˜ìŠ¤ ë ˆë²¨ @Transactional(readOnly = true)**
- ì´ìœ : ServiceëŠ” ì¡°íšŒ ë©”ì„œë“œê°€ 80% ì´ìƒ
- ì¥ì : Lazy Loading ì•ˆì „, ì¼ê´€ëœ íŠ¸ëœì­ì…˜ ê´€ë¦¬
- ë‹¨ì : ê±°ì˜ ì—†ìŒ

**âŒ Facadeì—ëŠ” í´ë˜ìŠ¤ ë ˆë²¨ @Transactional ì§€ì–‘**
- ì´ìœ : FacadeëŠ” ì¡°íšŒ+ì“°ê¸°ê°€ ì„ì—¬ìˆì–´ì„œ readOnly ê¸°ë³¸ê°’ì´ ë§ì§€ ì•ŠìŒ
- ëŒ€ì‹ : í•„ìš”í•œ ë©”ì„œë“œë§Œ ëª…ì‹œì ìœ¼ë¡œ @Transactional ì¶”ê°€

**ğŸ“‹ ì‹¤ì œ ì ìš© ì˜ˆì‹œ**
```java
// âœ… Service
@Service
@Transactional(readOnly = true)
public class UserService { ... }

@Service  
@Transactional(readOnly = true)
public class EmailVerificationService { ... }

// âœ… Facade  
@Service // í´ë˜ìŠ¤ ë ˆë²¨ íŠ¸ëœì­ì…˜ ì—†ìŒ
public class AuthFacade {
    
    public void resendEmail() { ... }  // ì¡°íšŒë§Œ â†’ Service TX í™œìš©
    
    @Transactional // ì›ìì„± í•„ìš”
    public void verifyEmail() { ... }
    
    public void signUp() { ... }  // ë…ë¦½ ì‹¤í–‰ â†’ Serviceë³„ TX
}
```

```java
// Service vs Facade íŠ¸ëœì­ì…˜ ì„¤ê³„ ë¹„êµ

// âœ… ì¶”ì²œ: Serviceì—ë§Œ í´ë˜ìŠ¤ ë ˆë²¨ @Transactional
@Service
@Transactional(readOnly = true) // ğŸ‘ ì¢‹ìŒ
public class UserService {
    
    public User findByEmail(String email) {
        // readOnly=true íŠ¸ëœì­ì…˜ì—ì„œ ì‹¤í–‰
        return userRepository.findByEmail(email)
            .orElseThrow(() -> new IllegalArgumentException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));
    }
    
    @Transactional // readOnly=falseë¡œ ì˜¤ë²„ë¼ì´ë“œ
    public void createUser(User user) {
        userRepository.save(user);
    }
}

@Service
@Transactional(readOnly = true) // ğŸ‘ ì¢‹ìŒ  
public class EmailVerificationService {
    
    public EmailVerification findByToken(String token) {
        // readOnly=true íŠ¸ëœì­ì…˜ì—ì„œ ì‹¤í–‰
        return repository.findByToken(token)
            .orElseThrow(() -> new IllegalArgumentException("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°"));
    }
    
    @Transactional // readOnly=falseë¡œ ì˜¤ë²„ë¼ì´ë“œ
    public void createEmailVerification(User user, String token) {
        // ì €ì¥ ë¡œì§
    }
}

// âŒ ë¹„ì¶”ì²œ: Facadeì— í´ë˜ìŠ¤ ë ˆë²¨ @Transactional
@Service
@Transactional(readOnly = true) // ğŸ‘ ë¬¸ì œ ë§ìŒ
public class AuthFacade {
    
    // ë¬¸ì œ 1: ëª¨ë“  ë©”ì„œë“œê°€ readOnly íŠ¸ëœì­ì…˜
    public void signUp(CreateUserReq req) {
        // readOnly=true íŠ¸ëœì­ì…˜ì´ ì‹œì‘ë¨
        userService.createUser(user);                    // ì“°ê¸° ì‘ì—…ì¸ë° readOnly?
        emailService.createEmailVerification(user, token); // ì“°ê¸° ì‘ì—…ì¸ë° readOnly?
        
        // Spring: "readOnly íŠ¸ëœì­ì…˜ì—ì„œ ì“°ê¸° ì‹œë„? ì˜¤ë¥˜ ë°œìƒ!"
    }
    
    // ëª¨ë“  ì“°ê¸° ë©”ì„œë“œë§ˆë‹¤ @Transactional ì˜¤ë²„ë¼ì´ë“œ í•„ìš”
    @Transactional // ğŸ‘ ë²ˆê±°ë¡œì›€
    public void verifyEmail(String token) {
        // ...
    }
    
    @Transactional // ğŸ‘ ë²ˆê±°ë¡œì›€  
    public void resetPassword(String email) {
        // ...
    }
}

// âœ… ì¶”ì²œ: FacadeëŠ” íŠ¸ëœì­ì…˜ ì„¤ì • ì—†ì´, í•„ìš”í•œ ê³³ë§Œ ëª…ì‹œì ìœ¼ë¡œ
@Service // í´ë˜ìŠ¤ ë ˆë²¨ @Transactional ì—†ìŒ
public class AuthFacade {
    
    // ì¡°íšŒë§Œ í•˜ëŠ” ë©”ì„œë“œ - íŠ¸ëœì­ì…˜ ì„¤ì • ì—†ìŒ (ê° Serviceì—ì„œ ê´€ë¦¬)
    public void resendEmail(ResendEmailReq req) {
        User user = userService.findByEmailAndIsDeletedFalse(req.getEmail()); // Serviceì˜ readOnly TX
        EmailVerification verification = emailService.findByToken(token);      // Serviceì˜ readOnly TX
        
        applicationEventPublisher.publishEvent(new ResendVerificationEmailEvent(user.getEmail(), verification.getVerificationToken()));
    }
    
    // ì›ìì„±ì´ í•„ìš”í•œ ë©”ì„œë“œë§Œ ëª…ì‹œì ìœ¼ë¡œ @Transactional
    @Transactional
    public void verifyEmail(String token) {
        EmailVerification verification = getValidEmailVerification(token);
        User user = verification.getUser();

        // ë‘ ì‘ì—…ì´ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨
        userService.updateUserStatusActive(user);
        emailVerificationService.updateEmailVerification(verification);
    }
    
    // ê°ê° ë…ë¦½ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰í•˜ê³  ì‹¶ì€ ë©”ì„œë“œ - @Transactional ì—†ìŒ
    public void signUp(CreateUserReq req) {
        User user = CreateUserReq.toEntity(req, passwordEncoder.encode(req.getPassword()));
        userService.createUser(user);               // ë…ë¦½ íŠ¸ëœì­ì…˜ 1

        String emailToken = tokenService.generateVerificationToken(user.getId(), user.getEmail(), VerificationType.SIGNUP);
        emailVerificationService.createEmailVerification(user, emailToken); // ë…ë¦½ íŠ¸ëœì­ì…˜ 2

        applicationEventPublisher.publishEvent(new SendVerificationEmailEvent(user.getEmail(), emailToken));
    }
}

// ì‹¤ì œ ì‹¤í–‰ íë¦„ ë¹„êµ

// Case 1: Serviceë§Œ @Transactional(readOnly=true)
/*
AuthFacade.resendEmail() í˜¸ì¶œ
â”œâ”€ userService.findByEmail() â†’ readOnly TX ìƒì„± â†’ ì¡°íšŒ â†’ TX ì¢…ë£Œ
â”œâ”€ emailService.findByToken() â†’ readOnly TX ìƒì„± â†’ ì¡°íšŒ â†’ TX ì¢…ë£Œ  
â””â”€ ì´ë²¤íŠ¸ ë°œí–‰ (íŠ¸ëœì­ì…˜ ì™¸ë¶€)

AuthFacade.verifyEmail() í˜¸ì¶œ (@Transactional ëª…ì‹œ)
â”œâ”€ AuthFacade TX ì‹œì‘ (readOnly=false)
â”œâ”€ userService.updateStatus() â†’ ê¸°ì¡´ TX ì°¸ì—¬
â”œâ”€ emailService.updateVerification() â†’ ê¸°ì¡´ TX ì°¸ì—¬
â””â”€ AuthFacade TX ì»¤ë°‹
*/

// Case 2: Facadeì—ë„ @Transactional(readOnly=true) - ë¬¸ì œ ë°œìƒ
/*
AuthFacade.signUp() í˜¸ì¶œ
â”œâ”€ AuthFacade readOnly TX ì‹œì‘ âŒ
â”œâ”€ userService.createUser() â†’ readOnly TXì— ì°¸ì—¬í•˜ë ¤ í•¨
â”‚   â””â”€ ì“°ê¸° ì‘ì—… ì‹œë„ â†’ SQLException ë˜ëŠ” TransactionException ë°œìƒ! âŒ
â””â”€ ì‹¤íŒ¨
*/

// ì™œ Facadeì— readOnlyë¥¼ ë¶™ì´ë©´ ì•ˆ ë˜ëŠ”ê°€?

// 1. Facadeì˜ ì—­í• 
/*
- ì—¬ëŸ¬ Serviceë¥¼ ì¡°í•©í•˜ëŠ” ì—­í• 
- ë¹„ì¦ˆë‹ˆìŠ¤ í”Œë¡œìš° ê´€ë¦¬
- íŠ¸ëœì­ì…˜ ê²½ê³„ ê²°ì • (ì›ìì„±ì´ í•„ìš”í•œ ê²½ìš°ë§Œ)
- ëŒ€ë¶€ë¶„ ì¡°íšŒ+ì“°ê¸°ê°€ ì„ì—¬ìˆìŒ
*/

// 2. Serviceì˜ ì—­í•   
/*
- ë‹¨ì¼ ë„ë©”ì¸ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- ëŒ€ë¶€ë¶„ ì¡°íšŒ ë©”ì„œë“œê°€ ë§ìŒ (CRUD ì¤‘ Rì´ 80%)
- readOnly ê¸°ë³¸ê°’ì´ í•©ë¦¬ì 
*/

// 3. ê¶Œì¥ íŒ¨í„´ ì •ë¦¬
@Service
@Transactional(readOnly = true) // âœ… Service: ì¡°íšŒ ì¤‘ì‹¬ì´ë¯€ë¡œ readOnly ê¸°ë³¸ê°’
public class UserService {
    
    public User findUser() { /* readOnly */ }
    public List<User> findUsers() { /* readOnly */ }
    public boolean existsUser() { /* readOnly */ }
    
    @Transactional // ì“°ê¸° ì‘ì—…ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì˜¤ë²„ë¼ì´ë“œ
    public void createUser() { /* ì“°ê¸° */ }
    
    @Transactional
    public void updateUser() { /* ì“°ê¸° */ }
}

@Service // âœ… Facade: íŠ¸ëœì­ì…˜ ì •ì±…ì„ ëª…ì‹œì ìœ¼ë¡œ ê´€ë¦¬
public class AuthFacade {
    
    // ì¡°íšŒë§Œ â†’ íŠ¸ëœì­ì…˜ ì„¤ì • ì—†ìŒ (Serviceì— ìœ„ì„)
    public SomeDto getSomeData() {
        return userService.findUser(); // Serviceì˜ readOnly TX ì‚¬ìš©
    }
    
    // ì›ìì„± í•„ìš” â†’ ëª…ì‹œì  @Transactional
    @Transactional  
    public void atomicOperation() {
        userService.updateUser();
        emailService.updateEmail();
    }
    
    // ë…ë¦½ ì‹¤í–‰ ì›í•¨ â†’ @Transactional ì—†ìŒ
    public void independentOperations() {
        userService.createUser();  // ë…ë¦½ TX1
        emailService.sendEmail();  // ë…ë¦½ TX2
    }
}
```